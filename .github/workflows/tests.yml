name: Run All Tests - Cypress & Vitest

# Trigger this workflow on push and pull requests
on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    branches: [ dev, main, master ]
  # Allow manual trigger from Actions tab
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'  # Changed to match your project requirements

jobs:
  # ============================================
  # JOB 1: VITEST UNIT TESTS (Whitebox Testing)
  # ============================================
  vitest-tests:
    name: Vitest Unit Tests (Whitebox)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm ci
        
      - name: üß™ Run Vitest Unit Tests
        run: npm run test:app
        continue-on-error: false
        
      - name: üìä Generate Coverage Report
        if: always()
        run: npm run test:coverage || echo "Coverage generation skipped"
        
      - name: üì§ Upload Vitest Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-test-results
          path: |
            coverage/
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üìù Vitest Test Summary
        if: always()
        run: |
          echo "## üß™ Vitest Unit Tests (Whitebox)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** Unit Testing (Whitebox)" >> $GITHUB_STEP_SUMMARY
          echo "**Framework:** Vitest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d coverage ]; then
            echo "‚úÖ Coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 2: CYPRESS E2E TESTS (Blackbox Testing)
  # ============================================
  cypress-tests:
    name: Cypress E2E Tests (Blackbox)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm ci
        
      - name: üèóÔ∏è Build Application
        run: npm run build
        
      - name: üóÑÔ∏è Setup Test Database
        run: npm run test:db
        
      - name: üöÄ Start Application Server
        run: |
          npm run test:server &
          echo "Waiting for server to start..."
          sleep 10
        env:
          NODE_ENV: test
          
      - name: üîç Verify Server is Running
        run: |
          max_attempts=30
          attempt=0
          # Check both port 3000 (frontend) and backend
          until curl -f http://localhost:3000 || [ $attempt -eq $max_attempts ]; do
            echo "Waiting for server... (attempt $((attempt+1))/$max_attempts)"
            sleep 2
            attempt=$((attempt+1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Server failed to start"
            exit 1
          fi
          echo "‚úÖ Server is running"
          
      - name: üß™ Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          config-file: cypress.config.js
        env:
          CYPRESS_BASE_URL: http://localhost:3000
          NODE_ENV: test
          
      - name: üì∏ Upload Cypress Screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üé• Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üìù Cypress Test Summary
        if: always()
        run: |
          echo "## üé≠ Cypress E2E Tests (Blackbox)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** End-to-End Testing (Blackbox)" >> $GITHUB_STEP_SUMMARY
          echo "**Framework:** Cypress" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** Chrome" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "failure" ]; then
            echo "‚ö†Ô∏è Tests failed - check screenshots and videos in artifacts" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 3: TEST RESULTS SUMMARY
  # ============================================
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [vitest-tests, cypress-tests]
    if: always()
    
    steps:
      - name: üìä Generate Final Summary
        run: |
          echo "# üéØ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Framework | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Whitebox) | Vitest | ${{ needs.vitest-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests (Blackbox) | Cypress | ${{ needs.cypress-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.vitest-tests.result }}" == "success" ] && [ "${{ needs.cypress-tests.result }}" == "success" ]; then
            echo "### ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All test suites executed successfully. Code is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed test jobs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: üéâ Success Notification
        if: needs.vitest-tests.result == 'success' && needs.cypress-tests.result == 'success'
        run: |
          echo "=================================="
          echo "‚úÖ ALL TESTS PASSED SUCCESSFULLY!"
          echo "=================================="
          echo ""
          echo "Vitest Unit Tests: ‚úÖ PASSED"
          echo "Cypress E2E Tests: ‚úÖ PASSED"
          echo ""
          echo "Your code is ready for deployment! üöÄ"
          
      - name: ‚ùå Failure Notification
        if: needs.vitest-tests.result != 'success' || needs.cypress-tests.result != 'success'
        run: |
          echo "=================================="
          echo "‚ùå SOME TESTS FAILED"
          echo "=================================="
          echo ""
          echo "Vitest Unit Tests: ${{ needs.vitest-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo "Cypress E2E Tests: ${{ needs.cypress-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo ""
          echo "Please review the test results and fix the issues."
          exit 1
