name: Run All Tests - Vitest, Jest & Cypress

# Trigger this workflow on push and pull requests
on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    branches: [ dev, main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  # ============================================
  # JOB 1: VITEST UNIT TESTS (Existing Tests)
  # ============================================
  vitest-tests:
    name: Vitest Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm ci
        
      - name: üß™ Run Vitest Unit Tests
        run: npm run test:vitest
        continue-on-error: false
        
      - name: üìä Generate Vitest Coverage
        if: always()
        run: npm run test:vitest:coverage || echo "Vitest coverage skipped"
        
      - name: üì§ Upload Vitest Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-coverage
          path: coverage/
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üìù Vitest Summary
        if: always()
        run: |
          echo "## üß™ Vitest Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Framework:** Vitest (Fast Vite-native testing)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: JEST UNIT TESTS (Whitebox Testing)
  # ============================================
  jest-tests:
    name: Jest Unit Tests (Whitebox)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm ci
        
      - name: üß™ Run Jest Unit Tests
        run: npm run test:jest
        continue-on-error: false
        
      - name: üìä Generate Jest Coverage
        if: always()
        run: npm run test:jest:coverage || echo "Jest coverage skipped"
        
      - name: üì§ Upload Jest Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: coverage-jest/
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üìù Jest Summary
        if: always()
        run: |
          echo "## üß™ Jest Unit Tests (Whitebox)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Framework:** Jest" >> $GITHUB_STEP_SUMMARY
          echo "**Test Locations:**" >> $GITHUB_STEP_SUMMARY
          echo "- test/whitebox/ (hooks, utilities)" >> $GITHUB_STEP_SUMMARY
          echo "- app/**/__tests__/ (components)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 3: CYPRESS E2E TESTS (Blackbox Testing)
  # ============================================
  cypress-tests:
    name: Cypress E2E Tests (Blackbox)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm ci
        
      - name: üèóÔ∏è Build Application
        run: npm run build
        
      - name: üóÑÔ∏è Setup Test Database
        run: npm run test:db
        
      - name: üöÄ Start Application Server
        run: |
          npm run test:server &
          echo "Server started, waiting for it to be ready..."
          sleep 10
        env:
          NODE_ENV: test
          
      - name: üîç Verify Server is Running
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:3000 2>/dev/null || [ $attempt -eq $max_attempts ]; do
            echo "Waiting for server... (attempt $((attempt+1))/$max_attempts)"
            sleep 2
            attempt=$((attempt+1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Server failed to start"
            exit 1
          fi
          echo "‚úÖ Server is running on port 3000"
          
      - name: üß™ Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          config-file: cypress.config.js
        env:
          CYPRESS_BASE_URL: http://localhost:3000
          NODE_ENV: test
          
      - name: üì∏ Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üé• Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 30
          if-no-files-found: ignore
          
      - name: üìù Cypress Summary
        if: always()
        run: |
          echo "## üé≠ Cypress E2E Tests (Blackbox)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Framework:** Cypress" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** Chrome" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: TEST RESULTS SUMMARY
  # ============================================
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [vitest-tests, jest-tests, cypress-tests]
    if: always()
    
    steps:
      - name: üìä Generate Final Summary
        run: |
          echo "# üéØ Complete Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Framework | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Vitest) | Vitest | ${{ needs.vitest-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Jest - Whitebox) | Jest | ${{ needs.jest-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests (Blackbox) | Cypress | ${{ needs.cypress-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.vitest-tests.result }}" == "success" ] && [ "${{ needs.jest-tests.result }}" == "success" ] && [ "${{ needs.cypress-tests.result }}" == "success" ]; then
            echo "### ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All test suites executed successfully:" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Vitest unit tests" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Jest whitebox tests" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Cypress E2E tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Code is ready for deployment! üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed test jobs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: üéâ Success Notification
        if: needs.vitest-tests.result == 'success' && needs.jest-tests.result == 'success' && needs.cypress-tests.result == 'success'
        run: |
          echo "========================================"
          echo "‚úÖ ALL TESTS PASSED SUCCESSFULLY!"
          echo "========================================"
          echo ""
          echo "Vitest Unit Tests:    ‚úÖ PASSED"
          echo "Jest Whitebox Tests:  ‚úÖ PASSED"
          echo "Cypress E2E Tests:    ‚úÖ PASSED"
          echo ""
          echo "Your code is ready for deployment! üöÄ"
          
      - name: ‚ùå Failure Notification
        if: needs.vitest-tests.result != 'success' || needs.jest-tests.result != 'success' || needs.cypress-tests.result != 'success'
        run: |
          echo "========================================"
          echo "‚ùå SOME TESTS FAILED"
          echo "========================================"
          echo ""
          echo "Vitest Unit Tests:    ${{ needs.vitest-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo "Jest Whitebox Tests:  ${{ needs.jest-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo "Cypress E2E Tests:    ${{ needs.cypress-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo ""
          echo "Please review the test results and fix the issues."
          exit 1
